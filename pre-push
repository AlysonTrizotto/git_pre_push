#!/bin/sh

set -eu

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

# Detect environment (prefer shell APP_ENV, fallback to .env)
ENVIRONMENT="${APP_ENV:-}"
if [ -z "$ENVIRONMENT" ] && [ -f .env ]; then
  ENVIRONMENT="$(grep -m1 -E '^APP_ENV=' .env | sed -E 's/^APP_ENV=//; s/["\r]//g')"
fi
ENVIRONMENT_LC="$(printf '%s' "$ENVIRONMENT" | tr '[:upper:]' '[:lower:]')"

# Skip tests on production environment
if [ "$ENVIRONMENT_LC" = "production" ]; then
  echo "APP_ENV=production detectado. Pulando testes e permitindo push."
  exit 0
fi

echo "Running Laravel tests before push..."

if ! command -v php >/dev/null 2>&1; then
  echo "PHP não encontrado no PATH. Abortando push."
  exit 1
fi

if [ ! -f artisan ]; then
  echo "Arquivo 'artisan' não encontrado na raiz do projeto. Abortando."
  exit 1
fi

php artisan test

# Check the exit status of the test command
if [ $? -ne 0 ]; then
    echo "Tests failed! Aborting push."
    exit 1
else
    echo "All tests passed. Proceeding with push."
    exit 0
fi